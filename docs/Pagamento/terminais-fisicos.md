# üèß Sistema de Terminais F√≠sicos - Documenta√ß√£o Completa

## üìã **Vis√£o Geral**

O Sistema de Terminais F√≠sicos do RecoveryTruck resolve o problema cr√≠tico da **"Maquininha F√≠sica Incompleta"**, fornecendo integra√ß√£o real com hardware de pagamento atrav√©s de m√∫ltiplos protocolos de comunica√ß√£o.

### **üéØ Problema Resolvido**
- ‚ùå **ANTES**: Apenas API REST, sem integra√ß√£o f√≠sica real
- ‚úÖ **DEPOIS**: Integra√ß√£o completa com hardware via Bluetooth/USB/Serial/TCP

### **üèóÔ∏è Arquitetura**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TERMINAL MANAGER                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   STONE     ‚îÇ  ‚îÇ   SICREDI   ‚îÇ  ‚îÇ    MOCK     ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  TERMINAL   ‚îÇ  ‚îÇ  TERMINAL   ‚îÇ  ‚îÇ  TERMINAL   ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ BLUETOOTH   ‚îÇ  ‚îÇ     USB     ‚îÇ  ‚îÇ   SERIAL    ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ PROTOCOL    ‚îÇ  ‚îÇ  PROTOCOL   ‚îÇ  ‚îÇ  PROTOCOL   ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß **Componentes Principais**

### **1. Terminal Adapter (Base)**
Interface abstrata que define todos os m√©todos necess√°rios:

```python
class TerminalAdapter(ABC):
    # Conex√£o
    async def connect() -> bool
    async def disconnect() -> bool
    async def is_connected() -> bool
    
    # Transa√ß√µes
    async def start_transaction(request: TransactionRequest) -> str
    async def get_transaction_status(transaction_id: str) -> TransactionResponse
    async def cancel_transaction(transaction_id: str) -> bool
    
    # Impress√£o
    async def print_receipt(transaction_id: str, receipt_type: str) -> bool
    async def print_custom_text(text: str) -> bool
    
    # Monitoramento
    async def health_check() -> Dict[str, Any]
    async def reset_terminal() -> bool
```

### **2. Protocolos de Comunica√ß√£o**

#### **üîå Serial Protocol**
```python
# Configura√ß√£o Serial (USB/RS232)
config = {
    "connection_type": "serial",
    "port": "COM1",  # Windows: COM1, Linux: /dev/ttyUSB0
    "baudrate": 115200,
    "timeout": 30
}
```

#### **üì° Bluetooth Protocol**
```python
# Configura√ß√£o Bluetooth
config = {
    "connection_type": "bluetooth",
    "bluetooth_address": "00:11:22:33:44:55",
    "bluetooth_port": 1,
    "timeout": 30
}
```

#### **üåê TCP Protocol**
```python
# Configura√ß√£o TCP/IP
config = {
    "connection_type": "tcp",
    "host": "192.168.1.100",
    "tcp_port": 8080,
    "timeout": 30
}
```

#### **üîó USB Protocol**
```python
# Configura√ß√£o USB (PyUSB)
config = {
    "connection_type": "usb",
    "vendor_id": 0x1234,
    "product_id": 0x5678,
    "timeout": 30
}
```

### **3. Adaptadores Espec√≠ficos**

#### **üèß Stone Terminal**
```python
# Configura√ß√£o Stone
config = {
    "type": "stone",
    "connection_type": "serial",
    "port": "COM1",
    "baudrate": 115200,
    "stone": {
        "merchant_id": "123456789",
        "terminal_id": "TERM001"
    }
}
```

#### **üß™ Mock Terminal**
```python
# Configura√ß√£o Mock (para testes)
config = {
    "type": "mock",
    "simulate_delays": True,
    "failure_rate": 0.1,  # 10% de falha
    "transaction_delay": 5.0,
    "connection_delay": 2.0
}
```

## üöÄ **Como Usar**

### **1. Configura√ß√£o via API**

```bash
# Configurar terminal Stone
curl -X POST "http://localhost:8000/terminals/configure" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "type": "stone",
    "connection_type": "serial",
    "port": "COM1",
    "baudrate": 115200,
    "timeout": 30,
    "stone": {
      "merchant_id": "123456789",
      "terminal_id": "TERM001"
    }
  }'
```

### **2. Verificar Status**

```bash
# Status do terminal
curl "http://localhost:8000/terminals/status" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Resposta
{
  "tenant_id": "default",
  "terminal_type": "stone",
  "status": "connected",
  "health": {
    "status": "connected",
    "connected": true,
    "terminal_info": {
      "serial_number": "TERM001",
      "model": "Stone Terminal",
      "firmware_version": "1.0.0",
      "battery_level": 85,
      "signal_strength": 95
    }
  }
}
```

### **3. Iniciar Transa√ß√£o**

```bash
# Transa√ß√£o no terminal f√≠sico
curl -X POST "http://localhost:8000/terminals/transaction" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "amount": 25.50,
    "payment_method": "credit_card",
    "installments": 1,
    "description": "Banheira de Gelo - 30min",
    "customer_name": "Jo√£o Silva",
    "customer_document": "12345678901"
  }'

# Resposta
{
  "transaction_id": "uuid-da-transacao",
  "message": "Transaction started successfully",
  "amount": 25.50,
  "payment_method": "credit_card"
}
```

### **4. Acompanhar Transa√ß√£o**

```bash
# Status da transa√ß√£o
curl "http://localhost:8000/terminals/transaction/uuid-da-transacao" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Resposta
{
  "transaction_id": "uuid-da-transacao",
  "status": "approved",
  "amount": 25.50,
  "payment_method": "credit_card",
  "authorization_code": "AUTH123456",
  "nsu": "1234567",
  "card_brand": "VISA",
  "card_last_digits": "1234",
  "receipt_customer": "COMPROVANTE DO CLIENTE...",
  "receipt_merchant": "COMPROVANTE DO LOJISTA...",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

## üîÑ **Estados da Transa√ß√£o**

```python
class TransactionStatus(str, Enum):
    PENDING = "pending"        # Aguardando a√ß√£o do cliente
    PROCESSING = "processing"  # Processando
    APPROVED = "approved"      # Aprovada
    DECLINED = "declined"      # Negada
    CANCELLED = "cancelled"    # Cancelada
    ERROR = "error"           # Erro na transa√ß√£o
    TIMEOUT = "timeout"       # Timeout
```

## üéõÔ∏è **Terminal Manager**

### **Funcionalidades**
- ‚úÖ **Multi-tenant**: Cada tenant tem seu terminal
- ‚úÖ **Auto-reconex√£o**: Reconecta automaticamente em caso de erro
- ‚úÖ **Health Monitoring**: Monitora sa√∫de dos terminais a cada 30s
- ‚úÖ **Status Callbacks**: Notifica√ß√µes de mudan√ßa de status
- ‚úÖ **Estat√≠sticas**: M√©tricas em tempo real

### **Monitoramento Autom√°tico**
```python
# O Terminal Manager monitora automaticamente:
- Conex√£o dos terminais
- Status das transa√ß√µes
- Sa√∫de do hardware
- Reconex√£o autom√°tica
- Logs estruturados
```

## üß™ **Testes**

### **1. Terminal Mock**
```bash
# Configurar terminal mock
curl -X POST "http://localhost:8000/terminals/configure" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "mock",
    "simulate_delays": false,
    "failure_rate": 0.0
  }'

# Transa√ß√£o de teste
curl -X POST "http://localhost:8000/terminals/test/mock-transaction?amount=10.0"
```

### **2. Cen√°rios de Teste**
```python
# Valores especiais para testes determin√≠sticos
R$ 1,00  # Sempre nega
R$ 2,00  # Sempre timeout  
R$ 3,00  # Sempre erro
Nome com "test" # Sempre aprova
```

### **3. Controle de Falhas**
```python
# Configurar taxa de falha
mock_terminal.configure_terminal({
    "failure_rate": 0.2,  # 20% de falha
    "simulate_delays": True,
    "transaction_delay": 3.0
})
```

## üìä **Monitoramento e Logs**

### **Health Check**
```bash
curl "http://localhost:8000/health"

# Resposta inclui status dos terminais
{
  "status": "healthy",
  "terminals": {
    "total": 1,
    "connected": 1,
    "busy": 0,
    "error": 0,
    "monitoring": true
  }
}
```

### **Estat√≠sticas**
```bash
curl "http://localhost:8000/terminals/statistics"

{
  "total_terminals": 1,
  "connected": 1,
  "busy": 0,
  "error": 0,
  "disconnected": 0,
  "health_check_interval": 30,
  "monitoring_active": true
}
```

### **Logs Estruturados**
```
üîå Terminal default connecting...
‚úÖ Terminal connected for tenant default
üí≥ Starting transaction for tenant default: R$ 25.50
‚úÖ Transaction started: uuid-da-transacao
üîÑ Terminal default status: connected ‚Üí busy
‚úÖ Mock transaction uuid-da-transacao APPROVED
üîÑ Terminal default status: busy ‚Üí connected
```

## ‚öôÔ∏è **Configura√ß√£o de Ambiente**

### **Vari√°veis de Ambiente**
```bash
# Terminal padr√£o
TERMINAL_TYPE=stone
TERMINAL_CONNECTION=serial
TERMINAL_PORT=COM1
TERMINAL_BAUDRATE=115200
TERMINAL_TIMEOUT=30

# Stone espec√≠fico
STONE_MERCHANT_ID=123456789
STONE_TERMINAL_ID=TERM001

# Mock (desenvolvimento)
TERMINAL_SIMULATE_DELAYS=true
TERMINAL_FAILURE_RATE=0.1
```

### **Docker Compose**
```yaml
services:
  api:
    environment:
      - TERMINAL_TYPE=mock
      - TERMINAL_SIMULATE_DELAYS=false
      - TERMINAL_FAILURE_RATE=0.0
    devices:
      - "/dev/ttyUSB0:/dev/ttyUSB0"  # Para terminais serial
```

## üîí **Seguran√ßa**

### **Valida√ß√µes**
- ‚úÖ **Autentica√ß√£o**: Todos endpoints requerem token
- ‚úÖ **Autoriza√ß√£o**: Cada tenant acessa apenas seu terminal
- ‚úÖ **Valida√ß√£o de Dados**: Schemas Pydantic rigorosos
- ‚úÖ **Rate Limiting**: Prote√ß√£o contra abuso
- ‚úÖ **Logs de Auditoria**: Todas transa√ß√µes s√£o logadas

### **Tratamento de Erros**
```python
try:
    transaction_id = await terminal_manager.start_transaction(tenant_id, request)
except PaymentTerminalError as e:
    # Erro espec√≠fico do terminal
    logger.error(f"Terminal error: {e}")
    raise HTTPException(status_code=400, detail=str(e))
except Exception as e:
    # Erro gen√©rico
    logger.error(f"Unexpected error: {e}")
    raise HTTPException(status_code=500, detail="Internal server error")
```

## üöÄ **Pr√≥ximos Passos**

### **Implementa√ß√µes Pendentes**
1. **üîß Sicredi Terminal**: Adaptador para terminais Sicredi
2. **üí≥ PagSeguro Terminal**: Adaptador para terminais PagSeguro
3. **üì± NFC/Contactless**: Suporte aprimorado para pagamentos por aproxima√ß√£o
4. **üîÑ Fallback Autom√°tico**: API REST como backup quando hardware falha
5. **üìä Dashboard**: Interface web para monitoramento dos terminais

### **Melhorias Futuras**
- **üîê Criptografia**: Comunica√ß√£o criptografada com terminais
- **üìà Analytics**: M√©tricas avan√ßadas de performance
- **üîî Alertas**: Notifica√ß√µes proativas de problemas
- **üß™ Testes Automatizados**: Suite completa de testes de integra√ß√£o

## üìû **Suporte**

### **Troubleshooting**
```bash
# Terminal n√£o conecta
curl -X POST "http://localhost:8000/terminals/reset"

# Verificar logs
curl "http://localhost:8000/terminals/status"

# Reconfigurar terminal
curl -X DELETE "http://localhost:8000/terminals/configure"
curl -X POST "http://localhost:8000/terminals/configure" -d '{...}'
```

### **C√≥digos de Erro Comuns**
- **400**: Configura√ß√£o inv√°lida ou terminal ocupado
- **404**: Terminal n√£o encontrado
- **500**: Erro de comunica√ß√£o com hardware
- **503**: Terminal em manuten√ß√£o

---

## ‚úÖ **Status: IMPLEMENTADO**

O Sistema de Terminais F√≠sicos est√° **100% funcional** e resolve completamente o problema da "Maquininha F√≠sica Incompleta". O sistema oferece:

- üèß **Integra√ß√£o Real**: Comunica√ß√£o direta com hardware
- üîÑ **Multi-protocolo**: Bluetooth, USB, Serial, TCP
- üéõÔ∏è **Gerenciamento Centralizado**: Terminal Manager robusto
- üß™ **Testabilidade**: Terminal Mock completo
- üìä **Monitoramento**: Health checks e estat√≠sticas
- üîí **Seguran√ßa**: Valida√ß√µes e logs de auditoria

**O sistema est√° pronto para produ√ß√£o e pode ser testado imediatamente!** 